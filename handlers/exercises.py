# -*- coding: utf-8 -*-
"""–†–∞–∑–¥–µ–ª ¬´–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è¬ª: –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏ –≤—ã–≤–æ–¥ –∫–∞—Ä—Ç–æ—á–∫–∏."""

from telegram import Update
from telegram.ext import ContextTypes, MessageHandler, CallbackQueryHandler, filters

from database import get_db
from handlers.keyboards import inline_list_keyboard


def _format_exercise(ex: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è."""
    name = ex.get("name", "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è")
    desc = ex.get("description", "")
    link = ex.get("link", "")
    keywords = ex.get("keywords")
    if isinstance(keywords, list):
        kw = ", ".join(keywords) if keywords else ""
    else:
        kw = str(keywords or "")
    lines = [f"<b>üìö {name}</b>", ""]
    if desc:
        lines.append(desc)
    if kw:
        lines.append(f"\nüè∑ –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: {kw}")
    if link:
        lines.append(f"\nüîó {link}")
    return "\n".join(lines)


async def show_exercises_search_prompt(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ó–∞–ø—Ä–æ—Å –Ω–∞–∑–≤–∞–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è."""
    context.user_data["expect"] = "exercise"
    await update.message.reply_text(
        "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–ª–∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞:",
    )


async def exercise_search_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: –ø–æ–∏—Å–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π.
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ ¬´–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è¬ª
    –∏–ª–∏ –≤–≤–æ–¥ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø–æ–∏—Å–∫–æ–º (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –≤ search.py –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç –∑–∞–ø—Ä–æ—Å—ã).
    –ó–¥–µ—Å—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –∏–∑ –∫–Ω–æ–ø–∫–∏ ¬´–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è¬ª ‚Äî —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –¥–µ–ª–∞–µ–º,
    –∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤ search: –ø–æ –∑–∞–ø—Ä–æ—Å—É –∏—â–µ–º –≤–µ–∑–¥–µ –∏–ª–∏ —Ç–æ–ª—å–∫–æ –≤ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è—Ö.
    –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã: –∫–Ω–æ–ø–∫–∞ ¬´–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è¬ª –≤–µ–¥—ë—Ç —Å—é–¥–∞, –∏ —Å–ª–µ–¥—É—é—â–∏–π –≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –ø–æ–∏—Å–∫ –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º.
    """
    query = (update.message.text or "").strip()
    if not query:
        await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞.")
        return
    db = get_db()
    results = db.search_exercises(query)
    if not results:
        await update.message.reply_text(
            "üòï –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏–µ —Å–ª–æ–≤–∞ –∏–ª–∏ —Ä–∞–∑–¥–µ–ª üîç –ü–æ–∏—Å–∫ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –≤—Å–µ–π –±–∞–∑–µ."
        )
        return
    if len(results) == 1:
        await update.message.reply_text(
            _format_exercise(results[0]),
            parse_mode="HTML",
        )
        return
    # –ù–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫
    await update.message.reply_text(
        f"–ù–∞–π–¥–µ–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π: {len(results)}. –í—ã–±–µ—Ä–∏—Ç–µ:",
        reply_markup=inline_list_keyboard(results, "ex", id_key="id", title_key="name"),
    )


async def exercise_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Callback: –≤—ã–±–æ—Ä —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–∑ —Å–ø–∏—Å–∫–∞."""
    await update.callback_query.answer()
    data = update.callback_query.data or ""
    if not data.startswith("ex:"):
        return
    ex_id = data[3:].strip()
    db = get_db()
    ex = db.get_exercise_by_id(ex_id)
    if not ex:
        await update.callback_query.edit_message_text("–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
        return
    await update.callback_query.edit_message_text(
        _format_exercise(ex),
        parse_mode="HTML",
    )


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏: callback –¥–ª—è –≤—ã–±–æ—Ä–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–∑ —Å–ø–∏—Å–∫–∞
# –¢–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ search.py (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫) –∏–ª–∏ –∑–¥–µ—Å—å
# –ß—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å: –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ ¬´–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è¬ª –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É; —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç –∏–¥—ë—Ç –≤ search –∏–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π handler.
# –†–µ—à–∞–µ–º —Ç–∞–∫: –≤—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–∫—Ä–æ–º–µ –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é) –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç search ‚Äî –æ–Ω –∏—â–µ—Ç –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º, —Ç–µ—Ä–º–∏–Ω–∞–º –∏ —Ç.–¥.
# –¢–æ–≥–¥–∞ –≤ ¬´–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è¬ª –º—ã —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É, –∞ –≤–≤–æ–¥ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç search. –ù–æ —Ç–æ–≥–¥–∞ search –¥–æ–ª–∂–µ–Ω –æ—Ç–¥–∞–≤–∞—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º –µ—Å–ª–∏ –Ω–∞—à–ª–∏.
# –ü—Ä–æ—â–µ: –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è ¬´–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è¬ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç ‚Äî –º—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ–≥–æ –≤ exercise_search_message. –î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –∑–∞–ø–æ–º–∏–Ω–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ¬´–∂–¥—ë–º –∑–∞–ø—Ä–æ—Å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è¬ª. –õ–∏–±–æ –±–µ–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è: –ª—é–±–æ–π —Ç–µ–∫—Å—Ç (–∫—Ä–æ–º–µ –∫–Ω–æ–ø–æ–∫) —Å—á–∏—Ç–∞–µ–º –∑–∞–ø—Ä–æ—Å–æ–º –∏ –∏—â–µ–º –≤ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è—Ö + —Ç–µ—Ä–º–∏–Ω–∞—Ö + –∫–æ–º–ø–ª–µ–∫—Å–∞—Ö –≤ search. –û–¥–∏–Ω —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫.
# –ü–æ –¢–ó: ¬´–ò—Å–∫–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é¬ª –≤ —Ä–∞–∑–¥–µ–ª–µ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, –∏ –æ—Ç–¥–µ–ª—å–Ω–æ ¬´–ü–æ–∏—Å–∫¬ª üîç. –ó–Ω–∞—á–∏—Ç: –≤ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ–∏—Å–∫ –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º; –≤ –ü–æ–∏—Å–∫ ‚Äî –ø–æ –≤—Å–µ–π –±–∞–∑–µ. –¢–æ–≥–¥–∞ –Ω—É–∂–µ–Ω state: –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Å—Ç–∞–≤–∏–º state=EXERCISE_SEARCH, —Å–ª–µ–¥—É—é—â–∏–π message –∏–¥—ë—Ç –≤ exercise_search_message. –ë–µ–∑ ConversationHandler –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ context.user_data["expect"] = "exercise".
# –î–µ–ª–∞—é —á–µ—Ä–µ–∑ user_data: –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ ¬´–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è¬ª —Å—Ç–∞–≤–∏–º expect = "exercise", –≤ message handler –ø—Ä–æ–≤–µ—Ä—è–µ–º: –µ—Å–ª–∏ expect == "exercise" –∏ —ç—Ç–æ –Ω–µ –∫–Ω–æ–ø–∫–∞ –º–µ–Ω—é ‚Äî –∏—â–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º expect.
exercises_handlers = [
    CallbackQueryHandler(exercise_callback, pattern="^ex:"),
]
